<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>수박 게임 🍉</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#fef6e4; display:flex; flex-direction:column; align-items:center; font-family:sans-serif; }
    h1 { margin:10px 0; }
    canvas { background:#d8f3dc; border:3px solid #40916c; border-radius:10px; }
    #scoreBoard { font-size:20px; margin:10px; }
  </style>
</head>
<body>
  <h1>🍒 수박 게임 🍉</h1>
  <div id="scoreBoard">점수: 0 | 최고점수: 0</div>
  <canvas id="game" width="400" height="600"></canvas>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const scoreBoard = document.getElementById("scoreBoard");

    // 과일 목록 (작을수록 가볍고, 클수록 무거움)
    const fruits = [
      {color:"#ff4d6d", radius:15, name:"체리"},
      {color:"#ff7096", radius:20, name:"딸기"},
      {color:"#9d4edd", radius:25, name:"포도"},
      {color:"#ffb703", radius:30, name:"사과"},
      {color:"#ffee32", radius:35, name:"레몬"},
      {color:"#70e000", radius:45, name:"멜론"},
      {color:"#008000", radius:55, name:"수박"},
      {color:"#a3c4f3", radius:65, name:"블루베리"},
      {color:"#e5989b", radius:75, name:"복숭아"},
      {color:"#cdb4db", radius:85, name:"자두"},
      {color:"#6a994e", radius:95, name:"참외"},
      {color:"#8ecae6", radius:105, name:"망고"},
      {color:"#f28482", radius:115, name:"자몽"},
      {color:"#d00000", radius:130, name:"석류"},
      {color:"#ffba08", radius:150, name:"황금수박"}
    ];

    let objects = [];
    let dropping = null;
    let score = 0;
    let highScore = Number(localStorage.getItem("highScore") || 0);
    let gameOver = false;

    function randomFruit() {
      return {...fruits[0], type:0}; // 체리부터 시작
    }

    function dropFruit() {
      if (dropping || gameOver) return;
      dropping = randomFruit();
      dropping.x = canvas.width / 2;
      dropping.y = 60;
      dropping.vx = 0;
      dropping.vy = 0;
    }

    document.addEventListener("mousemove", e => {
      if (dropping) {
        const rect = canvas.getBoundingClientRect();
        dropping.x = e.clientX - rect.left;
      }
    });

    document.addEventListener("click", () => {
      if (!dropping || gameOver) return;
      objects.push(dropping);
      dropping = null;
      dropFruit();
    });

    function update() {
      if (gameOver) return;

      // 과일 중력/이동 처리
      for (let o of objects) {
        const weight = 0.05 + o.radius / 200; // 클수록 무겁게
        o.vy += weight * 3; // 중력
        o.y += o.vy;
        o.x += o.vx;
        o.vx *= 0.98; // 공기저항

        // 바닥 충돌
        if (o.y + o.radius > canvas.height) {
          o.y = canvas.height - o.radius;
          o.vy *= -0.3; // 튕김
          o.vx *= 0.7; // 무거울수록 덜 움직임
          if (Math.abs(o.vy) < 0.5) o.vy = 0;
        }

        // 벽 충돌
        if (o.x - o.radius < 0 || o.x + o.radius > canvas.width) {
          o.vx *= -0.8;
          o.x = Math.max(o.radius, Math.min(canvas.width - o.radius, o.x));
        }
      }

      // 충돌 처리 (항상 확인)
      for (let i = 0; i < objects.length; i++) {
        for (let j = i + 1; j < objects.length; j++) {
          const a = objects[i];
          const b = objects[j];
          const dx = a.x - b.x;
          const dy = a.y - b.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < a.radius + b.radius) {
            // 서로 미는 물리 효과
            const overlap = (a.radius + b.radius - dist) / 2;
            const nx = dx / dist;
            const ny = dy / dist;
            a.x += nx * overlap;
            a.y += ny * overlap;
            b.x -= nx * overlap;
            b.y -= ny * overlap;

            // 충돌 후 합성
            if (Math.abs(a.vy - b.vy) < 2 && a.type === b.type && a.type < fruits.length - 1) {
              const next = fruits[a.type + 1];
              objects.splice(j, 1);
              objects.splice(i, 1);
              const newFruit = {...next, x:(a.x+b.x)/2, y:(a.y+b.y)/2, vx:0, vy:-5, type:a.type+1};
              objects.push(newFruit);
              score += (a.type + 1) * 10;
              updateScore();
              break;
            }
          }
        }
      }

      // 게임오버 판정 (높이)
      for (let o of objects) {
        if (o.y - o.radius < 50) {
          endGame();
          return;
        }
      }
    }

    function updateScore() {
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      scoreBoard.innerText = `점수: ${score} | 최고점수: ${highScore}`;
    }

    function endGame() {
      gameOver = true;
      ctx.fillStyle = "rgba(0,0,0,0.5)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "#fff";
      ctx.font = "32px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("게임 오버!", canvas.width/2, canvas.height/2);
      ctx.font = "20px sans-serif";
      ctx.fillText("클릭하면 다시 시작", canvas.width/2, canvas.height/2 + 40);

      document.addEventListener("click", resetGame, {once:true});
    }

    function resetGame() {
      objects = [];
      dropping = null;
      score = 0;
      gameOver = false;
      updateScore();
      dropFruit();
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // 드롭 중 과일
      if (dropping) {
        ctx.fillStyle = dropping.color;
        ctx.beginPath();
        ctx.arc(dropping.x, dropping.y, dropping.radius, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "12px bold sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(dropping.type ?? 0, dropping.x, dropping.y+4);
      }
      // 떨어진 과일
      for (let o of objects) {
        ctx.fillStyle = o.color;
        ctx.beginPath();
        ctx.arc(o.x, o.y, o.radius, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = "12px bold sans-serif";
        ctx.textAlign = "center";
        ctx.fillText(o.type ?? 0, o.x, o.y+4);
      }
    }

    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    updateScore();
    dropFruit();
    loop();
  </script>
</body>
</html>
